<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LUT/LAB Exam Room</title>
    <meta name="description" content="Exam room display utility for LUT and LAB Universities" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000' width='100' height='100'/><text x='50' y='68' font-size='48' font-weight='bold' fill='%23fff' text-anchor='middle' font-family='system-ui'>E</text></svg>"
    />
    <script src="https://unpkg.com/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        /* High contrast palette for projector visibility */
        --bg: #f5f5f5;
        --surface: #ffffff;
        --text: #000000;
        --text-secondary: #333333;
        --border: #cccccc;
        --border-strong: #666666;
        --accent: #c00000;
        --clock-bg: #000000;
        --clock-text: #ffffff;
      }

      html,
      body {
        height: 100%;
      }

      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.4;
      }

      .mono {
        font-family: ui-monospace, "Cascadia Code", Menlo, Consolas, monospace;
      }

      .app {
        min-height: 100%;
        display: flex;
        flex-direction: column;
      }

      /* ===== HEADER ===== */
      .header {
        background: var(--clock-bg);
        color: var(--clock-text);
        padding: 1.25rem 2rem;
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 2rem;
      }

      .mode-btn {
        padding: 0.5rem 1.25rem;
        font-size: 0.9rem;
        font-weight: 700;
        background: transparent;
        color: var(--clock-text);
        border: 2px solid var(--clock-text);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .mode-btn:hover {
        background: var(--clock-text);
        color: var(--clock-bg);
      }

      .header-main {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 3rem;
      }

      .clock-block {
        text-align: center;
      }

      .clock {
        font-size: 4rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        letter-spacing: 0.05em;
      }

      .date {
        font-size: 1rem;
        font-weight: 500;
        opacity: 0.7;
        margin-top: 0.25rem;
      }

      .header-divider {
        width: 1px;
        height: 4rem;
        background: rgba(255, 255, 255, 0.3);
      }

      .header-times {
        display: flex;
        gap: 2rem;
      }

      .header-time-block {
        text-align: center;
      }

      .header-time-label {
        font-size: 0.7rem;
        font-weight: 600;
        opacity: 0.6;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.2rem;
      }

      .header-time-value {
        font-size: 1.75rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
      }

      .header-end {
        width: 100px;
        text-align: right;
      }

      /* ===== SETTINGS BAR ===== */
      .settings-bar {
        background: var(--surface);
        border-bottom: 2px solid var(--border);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        gap: 2rem;
        flex-wrap: wrap;
      }

      .setting {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .setting-label {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text-secondary);
      }

      .setting-input {
        width: 70px;
        padding: 0.5rem;
        font-size: 1.1rem;
        font-weight: 700;
        border: 2px solid var(--border-strong);
        background: var(--bg);
        text-align: center;
      }

      .setting-time {
        display: flex;
        align-items: center;
        gap: 0.2rem;
      }

      .setting-time input {
        width: 55px;
        padding: 0.5rem 0.25rem;
        font-size: 1.1rem;
        font-weight: 700;
        border: 2px solid var(--border-strong);
        background: var(--bg);
        text-align: center;
        -moz-appearance: textfield;
      }

      .setting-time input::-webkit-outer-spin-button,
      .setting-time input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .setting-time-sep {
        font-size: 1.3rem;
        font-weight: 700;
      }

      .setting-unit {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .add-btn {
        margin-left: auto;
        padding: 0.6rem 1.5rem;
        font-size: 1rem;
        font-weight: 700;
        background: var(--text);
        color: var(--surface);
        border: none;
        cursor: pointer;
      }

      .add-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      /* ===== EXAMS LIST ===== */
      .exams {
        flex: 1;
        padding: 1.5rem 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-secondary);
        opacity: 0.5;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border: 4px dashed var(--border);
        margin: 2rem;
      }

      /* ===== EXAM CARD ===== */
      .exam {
        background: var(--surface);
        border: 2px solid var(--border);
      }

      .exam-top {
        display: flex;
      }

      .exam-color-bar {
        width: 20px;
      }

      .exam-header {
        flex: 1;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: baseline;
        gap: 1rem;
        border-bottom: 2px solid var(--border);
      }

      .exam-name {
        font-size: 2rem;
        font-weight: 700;
      }

      .exam-code {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-secondary);
      }

      .exam-body {
        display: flex;
      }

      .exam-body-spacer {
        width: 20px;
      }

      .exam-content {
        flex: 1;
        padding: 1rem 1.5rem;
        display: flex;
        gap: 2rem;
        align-items: flex-start;
      }

      .exam-notes {
        flex: 1;
      }

      .notes-label {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
      }

      .notes-text {
        font-size: 1.25rem;
        font-weight: 500;
        line-height: 1.5;
        white-space: pre-wrap;
      }

      /* ===== EXAM EDIT FORM ===== */
      .exam-edit {
        background: var(--bg);
        border-top: 2px solid var(--border);
        padding: 1rem 1.5rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: flex-end;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .field-label {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-secondary);
      }

      .field input,
      .field textarea {
        padding: 0.5rem;
        font-size: 1rem;
        border: 2px solid var(--border-strong);
        background: var(--surface);
        font-family: inherit;
      }

      .field input {
        height: 40px;
      }

      .field input[type="text"] {
        width: 180px;
      }
      .field input[type="time"] {
        width: 130px;
      }
      .field textarea {
        width: 260px;
        height: 60px;
        resize: vertical;
      }

      /* ===== CUSTOM COLOR PICKER ===== */
      .color-picker {
        position: relative;
        width: 180px;
      }

      .color-swatch {
        width: 100%;
        height: 40px;
        border: 2px solid var(--border-strong);
        cursor: pointer;
        position: relative;
        box-sizing: border-box;
      }

      .color-swatch::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 6px solid var(--text);
        pointer-events: none;
      }

      .color-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        z-index: 100;
        background: var(--surface);
        border: 2px solid var(--border-strong);
        border-radius: 0;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: none;
        width: 100%;
        box-sizing: border-box;
      }

      .color-dropdown.dropup {
        top: auto;
        bottom: calc(100% + 4px);
      }

      .color-dropdown.open {
        display: block;
      }

      .color-palette {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
      }

      .palette-color {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid rgba(0, 0, 0, 0.15);
        transition:
          transform 0.1s,
          box-shadow 0.1s;
      }

      .palette-color:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .palette-color.selected {
        outline: 2px solid var(--text);
        outline-offset: 2px;
      }

      .exam-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-left: auto;
      }

      .del-btn,
      .dup-btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        width: 120px;
        text-align: center;
      }

      .del-btn {
        background: var(--accent);
        color: white;
        border: none;
      }

      .dup-btn {
        background: var(--surface);
        color: var(--text);
        border: 2px solid var(--border-strong);
      }

      .dup-btn:hover {
        background: var(--bg);
      }

      .dup-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .remove-all-btn {
        margin-left: 1rem;
        padding: 0.6rem 1.5rem;
        font-size: 1rem;
        font-weight: 700;
        background: transparent;
        color: var(--accent);
        border: 2px solid var(--accent);
        cursor: pointer;
      }

      .remove-all-btn:hover {
        background: var(--accent);
        color: white;
      }

      .remove-all-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        border-color: var(--border-strong);
        color: var(--text-secondary);
        background: transparent;
      }

      /* ===== CONFIRMATION MODAL ===== */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s ease;
      }

      .modal-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }

      .modal {
        background: var(--surface);
        border: 4px solid var(--text);
        padding: 0;
        min-width: 320px;
        max-width: 400px;
        box-shadow: 12px 12px 0 rgba(0, 0, 0, 0.2);
        transform: scale(0.95);
        transition: transform 0.15s ease;
      }

      .modal-overlay.open .modal {
        transform: scale(1);
      }

      .modal-header {
        background: var(--text);
        color: var(--surface);
        padding: 1rem 1.5rem;
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .modal-content {
        padding: 2rem 1.5rem;
      }

      .modal-message {
        font-size: 1.1rem;
        color: var(--text);
        font-weight: 500;
        line-height: 1.5;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding: 0 1.5rem 1.5rem;
      }

      .modal-btn {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 700;
        border: 2px solid var(--text);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--surface);
        color: var(--text);
        transition: transform 0.1s, box-shadow 0.1s;
      }

      .modal-btn:hover {
        transform: translate(-2px, -2px);
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.1);
      }

      .modal-btn:active {
        transform: translate(0, 0);
        box-shadow: none;
      }

      .modal-btn.primary {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .modal-btn.primary:hover {
        background: #a00000;
      }

      .modal-btn:focus {
        outline: 2px solid var(--text);
        outline-offset: 4px;
      }

      /* ===== KEYBOARD SHORTCUTS HINT ===== */
      .kbd-hint {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-left: 0.5rem;
        opacity: 0.7;
      }

      .kbd {
        display: inline-block;
        padding: 0.1rem 0.3rem;
        background: var(--border);
        border-radius: 3px;
        font-family: ui-monospace, monospace;
        font-size: 0.8em;
      }

      /* ===== PRESENT MODE ===== */
      .present .header {
        padding: 1rem 2rem;
      }

      .present .settings-bar,
      .present .exam-edit {
        display: none;
      }

      .present .clock {
        font-size: 5rem;
      }

      .present .header-time-value {
        font-size: 2.25rem;
      }

      .present .header-divider {
        height: 5rem;
      }

      .present .exam-name {
        font-size: 1.75rem;
      }

      .present .exam-code {
        font-size: 1.1rem;
      }

      .present .time-value {
        font-size: 2rem;
      }

      .present .time-label {
        font-size: 0.8rem;
      }

      .present .notes-text {
        font-size: 1.1rem;
      }

      .present .notes-label {
        font-size: 0.8rem;
      }

      .present .exam-color-bar,
      .present .exam-body-spacer {
        width: 24px;
      }

      .present .exam-header {
        padding: 0.6rem 1.25rem;
      }

      .present .exam-content {
        padding: 0.6rem 1.25rem;
      }

      .present .exams {
        gap: 0.5rem;
        padding: 0.75rem 2rem;
      }

      /* ===== RESPONSIVE ===== */
      @media (max-width: 900px) {
        .header {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .header-end {
          display: none;
        }
        .clock {
          font-size: 3.5rem;
        }

        .clock-block {
          flex-direction: column;
          gap: 0.25rem;
          align-items: center;
        }

        .settings-bar {
          flex-direction: column;
          align-items: stretch;
          gap: 1rem;
        }

        .add-btn {
          margin-left: 0;
        }

        .exam-content {
          flex-direction: column;
          gap: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="app" id="app"></div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="modalTitle">Confirm Action</div>
        </div>
        <div class="modal-content">
          <div class="modal-message" id="modalMessage">Are you sure?</div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn" id="modalCancel">Cancel</button>
          <button class="modal-btn primary" id="modalConfirm">Confirm</button>
        </div>
      </div>
    </div>

    <script>
      const MAX_COURSES = 10;
      let state = {
        mode: "edit",
        startTime: "09:00",
        duration: 180,
        leaveAfter: 15,
        courses: [],
      };

      // Time offset from server (ms)
      let timeOffset = 0;
      let activeColorPicker = null;
      let modalCallback = null;

      const uuid = () => crypto.randomUUID?.() || Math.random().toString(36).slice(2);

      const esc = (s) =>
        s
          ? String(s)
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#39;")
          : "";

      const syncTime = async () => {
        try {
          // Use a more reliable way if possible, but worldtimeapi is okay as fallback
          const res = await fetch("https://worldtimeapi.org/api/timezone/Europe/Helsinki");
          if (!res.ok) throw new Error();
          const data = await res.json();
          const serverTime = new Date(data.datetime).getTime();
          const localTime = Date.now();
          timeOffset = serverTime - localTime;
          console.log(`Time synced. Offset: ${timeOffset}ms`);
        } catch (e) {
          console.warn("Time sync failed, using device time");
        }
      };

      const getSyncedDate = () => new Date(Date.now() + timeOffset);

      const clockFormatter = new Intl.DateTimeFormat("fi-FI", {
        timeZone: "Europe/Helsinki",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
      });

      const dateFormatter = new Intl.DateTimeFormat("en-GB", {
        timeZone: "Europe/Helsinki",
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric",
      });

      const finlandClock = () => clockFormatter.format(getSyncedDate());
      const finlandDate = () => dateFormatter.format(getSyncedDate());

      const addMins = (time, mins) => {
        const [h, m] = time.split(":").map(Number);
        const t = h * 60 + m + mins;
        return `${String(Math.floor(t / 60) % 24).padStart(2, "0")}:${String(t % 60).padStart(2, "0")}`;
      };

      const pack = () => ({
        s: state.startTime,
        d: state.duration,
        l: state.leaveAfter,
        c: state.courses.map((x) => [x.id.slice(0, 8), x.name, x.code, x.color, x.notes]),
      });

      const unpack = (d) => ({
        startTime: d.s || "09:00",
        duration: d.d || 180,
        leaveAfter: d.l || 15,
        courses: (d.c || d.e || []).map((x) => ({
          id: x[0] || uuid(),
          name: x[1] || "",
          code: x[2] || "",
          color: x[3] || "#2563eb",
          notes: x[4] || "",
        })),
      });

      const encode = () => LZString.compressToEncodedURIComponent(JSON.stringify(pack()));
      const decode = (s) => {
        try {
          const j = LZString.decompressFromEncodedURIComponent(s);
          return j ? unpack(JSON.parse(j)) : null;
        } catch {
          return null;
        }
      };
      const saveLocal = () => localStorage.setItem("lut-exam", JSON.stringify(pack()));
      const loadLocal = () => {
        try {
          const s = localStorage.getItem("lut-exam");
          return s ? unpack(JSON.parse(s)) : null;
        } catch {
          return null;
        }
      };
      const save = () => {
        saveLocal();
        history.replaceState(null, "", "#" + encode());
      };
      const load = () => {
        const h = location.hash.slice(1);
        const d = h ? decode(h) : loadLocal();
        if (d) {
          state.startTime = d.startTime;
          state.duration = d.duration;
          state.leaveAfter = d.leaveAfter;
          state.courses = d.courses;
        }
      };

      const render = () => {
        const p = state.mode === "present";
        const app = document.getElementById("app");
        app.className = p ? "app present" : "app";

        const end = addMins(state.startTime, state.duration);
        const leave = addMins(state.startTime, state.leaveAfter);

        let h = `
        <header class="header">
          <button class="mode-btn" onclick="toggleMode()">${p ? "◀ Edit" : "Present ▶"}<span class="kbd-hint"><span class="kbd">E</span></span></button>
          <div class="header-main">
            <div class="clock-block">
              <div class="clock mono" id="clock">${finlandClock()}</div>
              <div class="date">${finlandDate()}</div>
            </div>
            <div class="header-divider"></div>
            <div class="header-times">
              <div class="header-time-block">
                <div class="header-time-label">Start</div>
                <div class="header-time-value mono">${state.startTime}</div>
              </div>
              <div class="header-time-block">
                <div class="header-time-label">End</div>
                <div class="header-time-value mono">${end}</div>
              </div>
              <div class="header-time-block">
                <div class="header-time-label">May leave</div>
                <div class="header-time-value mono leave">${leave}</div>
              </div>
            </div>
          </div>
          <div class="header-end"></div>
        </header>
      `;

          const [startH, startM] = state.startTime.split(":");
          h += `
          <div class="settings-bar">
            <div class="setting">
              <span class="setting-label">Start</span>
              <div class="setting-time">
                <input type="text" maxlength="2" value="${startH}" onchange="setStartH(this.value)" onclick="this.select()">
                <span class="setting-time-sep">:</span>
                <input type="text" maxlength="2" value="${startM}" onchange="setStartM(this.value)" onclick="this.select()">
              </div>
            </div>
            <div class="setting">
              <span class="setting-label">Duration</span>
              <input class="setting-input" type="number" value="${state.duration}" min="1" max="600" onchange="setDuration(this.value)">
              <span class="setting-unit">min</span>
            </div>
            <div class="setting">
              <span class="setting-label">May leave after</span>
              <input class="setting-input" type="number" value="${state.leaveAfter}" min="0" max="600" onchange="setLeave(this.value)">
              <span class="setting-unit">min</span>
            </div>
            <div style="margin-left: auto; display: flex; gap: 1rem;">
              <button class="remove-all-btn" onclick="confirmRemoveAll()" ${!state.courses.length ? "disabled" : ""}>Remove All</button>
              <button class="add-btn" onclick="addCourse()" ${state.courses.length >= MAX_COURSES ? "disabled" : ""}>+ Add Course</button>
            </div>
          </div>
        `;


        h += '<main class="exams">';

        if (!state.courses.length) {
          h += `
            <div class="empty">
              <div>No courses</div>
              <div style="font-size: 1rem; font-weight: 500; opacity: 0.7;">Add a course to get started</div>
            </div>
          `;
        } else {
          for (const c of state.courses) {
            h += `
            <article class="exam">
              <div class="exam-top">
                <div class="exam-color-bar" style="background:${c.color}"></div>
                <div class="exam-header">
                  <span class="exam-name">${esc(c.name) || "Untitled"}</span>
                  <span class="exam-code">${esc(c.code)}</span>
                </div>
              </div>
              ${
                c.notes
                  ? `
                <div class="exam-body">
                  <div class="exam-body-spacer" style="background:${c.color}"></div>
                  <div class="exam-content">
                    <div class="exam-notes">
                      <div class="notes-label">Notes</div>
                      <div class="notes-text">${esc(c.notes)}</div>
                    </div>
                  </div>
                </div>
              `
                  : ""
              }
                <div class="exam-edit">
                  <div class="field">
                    <label class="field-label">Name</label>
                    <input type="text" value="${esc(c.name)}" onchange="updateCourse('${c.id}','name',this.value)">
                  </div>
                  <div class="field">
                    <label class="field-label">Code</label>
                    <input type="text" value="${esc(c.code)}" onchange="updateCourse('${c.id}','code',this.value)">
                  </div>
                  <div class="field">
                    <label class="field-label">Color</label>
                    <div class="color-picker" data-course-id="${c.id}">
                      <div class="color-swatch" style="background:${c.color}"></div>
                      <div class="color-dropdown">
                        <div class="color-palette"></div>
                      </div>
                    </div>
                  </div>
                  <div class="field">
                    <label class="field-label">Notes</label>
                    <textarea onchange="updateCourse('${c.id}','notes',this.value)">${esc(c.notes)}</textarea>
                  </div>
                  <div class="exam-actions">
                    <button class="dup-btn" onclick="dupCourse('${c.id}')" ${state.courses.length >= MAX_COURSES ? "disabled" : ""}>Duplicate</button>
                    <button class="del-btn" onclick="confirmDelete('${c.id}')">Delete</button>
                  </div>
                </div>

            </article>
          `;
          }
        }

        h += "</main>";
        app.innerHTML = h;

        // Initialize color pickers
        initColorPickers();
      };

      // Color palette - 12 distinct standard colors in good order
      const COLOR_PALETTE = [
        "#ef4444", // Red
        "#f97316", // Orange
        "#eab308", // Yellow
        "#22c55e", // Green
        "#06b6d4", // Cyan
        "#3b82f6", // Blue
        "#6366f1", // Indigo
        "#a855f7", // Purple
        "#ec4899", // Pink
        "#64748b", // Slate
        "#000000", // Black
        "#ffffff", // White
      ];

      function initColorPickers() {
        document.querySelectorAll(".color-picker").forEach((picker) => {
          const swatch = picker.querySelector(".color-swatch");
          const dropdown = picker.querySelector(".color-dropdown");
          const palette = picker.querySelector(".color-palette");
          const courseId = picker.dataset.courseId;

          // Populate palette
          palette.innerHTML = "";
          const rgbToHex = (rgb) => {
            if (rgb.startsWith("#")) return rgb;
            const match = rgb.match(/\d+/g);
            if (!match) return "#3b82f6";
            return (
              "#" +
              match
                .slice(0, 3)
                .map((x) => parseInt(x).toString(16).padStart(2, "0"))
                .join("")
            );
          };
          const currentColor = swatch.style.background || "#3b82f6";
          const currentHex = rgbToHex(currentColor);

          COLOR_PALETTE.forEach((color) => {
            const colorEl = document.createElement("div");
            colorEl.className = "palette-color";
            colorEl.style.background = color;
            if (color.toLowerCase() === currentHex.toLowerCase()) {
              colorEl.classList.add("selected");
            }
            colorEl.addEventListener("click", (e) => {
              e.stopPropagation();
              selectColor(courseId, color, picker);
            });
            palette.appendChild(colorEl);
          });

          // Toggle dropdown
          swatch.addEventListener("click", (e) => {
            e.stopPropagation();
            // Close other open dropdowns
            document.querySelectorAll(".color-dropdown.open").forEach((d) => {
              if (d !== dropdown) {
                d.classList.remove("open");
                d.classList.remove("dropup");
              }
            });

            const isOpening = !dropdown.classList.contains("open");
            dropdown.classList.toggle("open");
            activeColorPicker = isOpening ? picker : null;

            if (isOpening) {
              // Check if dropdown would go below viewport
              const swatchRect = swatch.getBoundingClientRect();
              const dropdownHeight = 140; // Approximate dropdown height
              const spaceBelow = window.innerHeight - swatchRect.bottom - 16;

              if (spaceBelow < dropdownHeight) {
                dropdown.classList.add("dropup");
              } else {
                dropdown.classList.remove("dropup");
              }
            }
          });

          // Prevent dropdown from closing when clicking inside
          dropdown.addEventListener("click", (e) => e.stopPropagation());
        });
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", () => {
        document.querySelectorAll(".color-dropdown.open").forEach((d) => d.classList.remove("open"));
        activeColorPicker = null;
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        // Handle Escape key first
        if (e.key === "Escape") {
          if (activeColorPicker) {
            activeColorPicker.querySelector(".color-dropdown").classList.remove("open");
            activeColorPicker = null;
            return;
          }
          const modal = document.getElementById("confirmModal");
          if (modal && modal.classList.contains("open")) {
            window.closeModal();
            return;
          }
          if (document.fullscreenElement || document.webkitFullscreenElement) {
            document.exitFullscreen?.() || document.webkitExitFullscreen?.();
            return;
          }
        }

        // Ignore other shortcuts if typing in an input/textarea
        if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;

        // E - Toggle edit/present mode
        if (e.key === "e" || e.key === "E") {
          e.preventDefault();
          window.toggleMode();
        }

        // F - Toggle fullscreen
        if (e.key === "f" || e.key === "F") {
          e.preventDefault();
          if (document.fullscreenElement || document.webkitFullscreenElement) {
            document.exitFullscreen?.() || document.webkitExitFullscreen?.();
          } else {
            document.documentElement.requestFullscreen?.() || document.documentElement.webkitRequestFullscreen?.();
          }
        }
      });

      function selectColor(courseId, color, picker) {
        const swatch = picker.querySelector(".color-swatch");
        const palette = picker.querySelector(".color-palette");

        swatch.style.background = color;
        updateCourse(courseId, "color", color);

        // Update selected state
        palette.querySelectorAll(".palette-color").forEach((el) => {
          el.classList.toggle("selected", el.style.background === color);
        });

        // Close dropdown
        picker.querySelector(".color-dropdown").classList.remove("open");
        activeColorPicker = null;
      }

      window.toggleMode = () => {
        state.mode = state.mode === "edit" ? "present" : "edit";
        if (state.mode === "present") {
          document.documentElement.requestFullscreen?.() ||
            document.documentElement.webkitRequestFullscreen?.();
        } else if (document.fullscreenElement || document.webkitFullscreenElement) {
          document.exitFullscreen?.() || document.webkitExitFullscreen?.();
        }
        render();
      };
      window.setStartH = (v) => {
        const h = Math.max(0, Math.min(23, parseInt(v) || 0));
        const [, m] = state.startTime.split(":");
        state.startTime = `${String(h).padStart(2, "0")}:${m}`;
        save();
        render();
      };
      window.setStartM = (v) => {
        const m = Math.max(0, Math.min(59, parseInt(v) || 0));
        const [h] = state.startTime.split(":");
        state.startTime = `${h}:${String(m).padStart(2, "0")}`;
        save();
        render();
      };
      window.setDuration = (v) => {
        state.duration = Math.max(1, +v || 180);
        save();
        render();
      };
      window.setLeave = (v) => {
        state.leaveAfter = Math.max(0, +v || 15);
        save();
        render();
      };
      window.addCourse = () => {
        if (state.courses.length >= MAX_COURSES) return;
        state.courses.push({ id: uuid(), name: "", code: "", color: "#3b82f6", notes: "" });
        save();
        render();
      };
      window.updateCourse = (id, k, v) => {
        const c = state.courses.find((x) => x.id === id);
        if (c) {
          c[k] = v;
          save();
          render();
        }
      };
      window.delCourse = (id) => {
        state.courses = state.courses.filter((x) => x.id !== id);
        save();
        render();
      };

      // Modal functions
      const showModal = (title, message, onConfirm) => {
        const overlay = document.getElementById("confirmModal");
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalMessage").textContent = message;
        modalCallback = onConfirm;
        overlay.classList.add("open");
        document.getElementById("modalConfirm").focus();
      };

      const closeModal = () => {
        document.getElementById("confirmModal").classList.remove("open");
        modalCallback = null;
      };

      // Initialize modal listeners once
      document.addEventListener("DOMContentLoaded", () => {
        const confirmBtn = document.getElementById("modalConfirm");
        const cancelBtn = document.getElementById("modalCancel");
        const overlay = document.getElementById("confirmModal");

        confirmBtn.addEventListener("click", () => {
          if (modalCallback) modalCallback();
          closeModal();
        });

        cancelBtn.addEventListener("click", closeModal);

        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) closeModal();
        });
      });

      window.confirmDelete = (id) => {
        const c = state.courses.find((x) => x.id === id);
        if (!c) return;
        const name = c.name || c.code || "Untitled Course";
        showModal(
          "Delete Course",
          `Are you sure you want to delete "${name}"?`,
          () => delCourse(id)
        );
      };

      window.confirmRemoveAll = () => {
        if (!state.courses.length) return;
        showModal(
          "Remove All Courses",
          "Are you sure you want to remove all courses? This cannot be undone.",
          () => removeAllCourses()
        );
      };

      window.removeAllCourses = () => {
        state.courses = [];
        save();
        render();
      };

      window.dupCourse = (id) => {
        if (state.courses.length >= MAX_COURSES) return;
        const idx = state.courses.findIndex((x) => x.id === id);
        if (idx === -1) return;
        const c = state.courses[idx];
        state.courses.splice(idx + 1, 0, {
          id: uuid(),
          name: c.name,
          code: c.code,
          color: c.color,
          notes: c.notes,
        });
        save();
        render();
      };

      window.closeModal = closeModal;

      load();
      syncTime();
      render();
      setInterval(() => {
        const el = document.getElementById("clock");
        if (el) el.textContent = finlandClock();
      }, 1000);
      // Re-sync every 10 minutes
      setInterval(syncTime, 10 * 60 * 1000);
    </script>
  </body>
</html>
